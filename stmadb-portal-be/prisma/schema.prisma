// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== MODUL 1: PENGGUNA & AKSES ==============

model Role {
  id        Int      @id @default(autoincrement())
  role_name String   @unique @db.VarChar(50)
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String
  is_active  Boolean   @default(true)
  last_login DateTime?
  roles      Role[]

  profile             Profile?
  teacher_extension   TeacherExtension?
  student_extension   StudentExtension?
  guardian_extension  GuardianExtension?
  duties              DutySchedule[]
  homeroom_class      Classes?          @relation("HomeroomTeacher")
  teacher_assignments TeacherAssignment[]
  teaching_journals   TeachingJournal[]
  class_memberships   ClassMember[]
  student_attendances Attendance[]

  leave_permits_requested LeavePermit[] @relation("Requester")
  leave_permits_approved  LeaveApproval[] @relation("Approver")
  leave_permits_printed   LeavePermit[] @relation("PrintedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Profile {
  id              Int       @id @default(autoincrement())
  full_name       String
  identity_number String?   @unique
  gender          Gender
  address         String?   @db.Text
  phone_number    String?
  photo_url       String?
  birth_date      DateTime?

  user_id Int  @unique
  user    User @relation(fields: [user_id], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Gender {
  Laki_laki
  Perempuan
}

enum EmploymentStatus {
  PNS
  PPPK
  GTT
}

model TeacherExtension {
  id      Int               @id @default(autoincrement())
  user_id Int               @unique
  user    User              @relation(fields: [user_id], references: [id])
  nip     String?           @unique
  status  EmploymentStatus?
}

model StudentExtension {
  id          Int                @id @default(autoincrement())
  user_id     Int                @unique
  user        User               @relation(fields: [user_id], references: [id])
  nisn        String             @unique
  guardian_id Int?
  guardian    GuardianExtension? @relation(fields: [guardian_id], references: [id])
  slim_id     String?            @unique
}

model GuardianExtension {
  id         Int                @id @default(autoincrement())
  user_id    Int                @unique
  user       User               @relation(fields: [user_id], references: [id])
  occupation String?
  students   StudentExtension[]
}

// ============== MODUL 2: STRUKTUR AKADEMIK & JADWAL ==============

model AcademicYear {
  id                  Int                 @id @default(autoincrement())
  year                String              @unique
  start_date          DateTime
  end_date            DateTime
  is_active           Boolean             @default(false)
  class_memberships   ClassMember[]
  teacher_assignments TeacherAssignment[]
  schedules           Schedule[]
  academic_weeks      AcademicWeek[]
  special_events      SpecialEvent[]
  // routine_activities   RoutineActivity[] // DIHAPUS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Major {
  id         Int       @id @default(autoincrement())
  major_name String    @unique
  major_code String    @unique
  classes    Classes[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Classes {
  id                  Int                 @id @default(autoincrement())
  class_name          String              @unique
  grade_level         Int
  major_id            Int
  major               Major               @relation(fields: [major_id], references: [id])
  homeroom_teacher_id Int?                @unique
  homeroom_teacher    User?               @relation("HomeroomTeacher", fields: [homeroom_teacher_id], references: [id])
  class_members       ClassMember[]
  teacher_assignments TeacherAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subject {
  id                  Int                 @id @default(autoincrement())
  subject_name        String
  subject_code        String              @unique
  teacher_assignments TeacherAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AcademicWeek {
  id               Int          @id @default(autoincrement())
  start_date       DateTime     @db.Date
  end_date         DateTime     @db.Date
  week_type        WeekType
  notes            String?
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
}

enum WeekType {
  A
  B
  Libur
  Ujian
  Acara
}

model Schedule {
  id                  Int               @id @default(autoincrement())
  day_of_week         DayOfWeek
  start_time          DateTime          @db.Time
  end_time            DateTime          @db.Time
  schedule_type       ScheduleType      @default(Umum)
  assignment_id       Int
  assignment          TeacherAssignment @relation(fields: [assignment_id], references: [id])
  academic_year_id    Int
  academic_year       AcademicYear      @relation(fields: [academic_year_id], references: [id])
  journals            TeachingJournal[]
  leave_permits       LeavePermit[]
  room_id             Int?
  room                Room?             @relation(fields: [room_id], references: [id])
}

enum DayOfWeek {
  Senin
  Selasa
  Rabu
  Kamis
  Jumat
}

enum ScheduleType {
  A
  B
  Umum
}

model SpecialEvent {
  id               Int          @id @default(autoincrement())
  event_name       String
  description      String?
  start_date       DateTime     @db.Date
  end_date         DateTime     @db.Date
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
}

model DutySchedule {
  id        Int      @id @default(autoincrement())
  user_id   Int
  user      User     @relation(fields: [user_id], references: [id])
  duty_date DateTime @db.Date
  duty_type String
  notes     String?
  @@unique([user_id, duty_date, duty_type])
}

model ClassMember {
  id               Int          @id @default(autoincrement())
  student_user_id  Int
  student          User         @relation(fields: [student_user_id], references: [id])
  class_id         Int
  class            Classes      @relation(fields: [class_id], references: [id])
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
  @@unique([student_user_id, academic_year_id])
}

model TeacherAssignment {
  id               Int          @id @default(autoincrement())
  teacher_user_id  Int
  teacher          User         @relation(fields: [teacher_user_id], references: [id])
  subject_id       Int
  subject          Subject      @relation(fields: [subject_id], references: [id])
  class_id         Int
  class            Classes      @relation(fields: [class_id], references: [id])
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
  schedules        Schedule[]
}

model TeachingJournal {
  id               Int        @id @default(autoincrement())
  journal_date     DateTime   @db.Date
  material_summary String     @db.Text
  teacher_notes    String?    @db.Text
  schedule_id      Int
  schedule         Schedule   @relation(fields: [schedule_id], references: [id])
  teacher_user_id  Int
  teacher          User       @relation(fields: [teacher_user_id], references: [id])
  attendances      Attendance[]
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

model Attendance {
  id              Int              @id @default(autoincrement())
  status          AttendanceStatus @default(Hadir)
  notes           String?
  journal_id      Int
  journal         TeachingJournal  @relation(fields: [journal_id], references: [id])
  student_user_id Int
  student         User             @relation(fields: [student_user_id], references: [id])
}

enum AttendanceStatus {
  Hadir
  Izin
  Sakit
  Alfa
}

model Room {
  id        Int      @id @default(autoincrement())
  room_name String
  room_code String   @unique
  schedules Schedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============== MODUL 3: IZIN KELUAR SEKOLAH ==============

model LeavePermit {
  id                  Int       @id @default(autoincrement())
  requester_user_id   Int
  requester           User      @relation("Requester", fields: [requester_user_id], references: [id])
  leave_type          LeavePermitType
  reason              String    @db.Text
  start_time          DateTime  @db.Timestamp()
  estimated_return    DateTime? @db.Timestamp()
  status              LeavePermitStatus @default(WaitingForPiket)
  approvals           LeaveApproval[]
  related_schedule_id Int?
  related_schedule    Schedule? @relation(fields: [related_schedule_id], references: [id])
  group_members       Json?
  printed_by_id       Int?
  printed_by          User?     @relation("PrintedBy", fields: [printed_by_id], references: [id])
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([requester_user_id])
  @@index([printed_by_id])
}

model LeaveApproval {
  id               Int            @id @default(autoincrement())
  leave_permit_id  Int
  leave_permit     LeavePermit    @relation(fields: [leave_permit_id], references: [id])
  approver_user_id Int
  approver         User           @relation("Approver", fields: [approver_user_id], references: [id])
  approver_role    String
  status           ApprovalStatus @default(Pending)
  notes            String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([leave_permit_id, approver_user_id])
  @@index([approver_user_id])
}

enum LeavePermitType {
  Individual
  Group
}

enum LeavePermitStatus {
  WaitingForPiket
  WaitingForApproval
  Approved
  Rejected
  Completed
}

enum ApprovalStatus {
  Pending
  Approved
  Rejected
}