// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== MODUL 1: PENGGUNA & AKSES ==============

model Role {
  id        Int      @id @default(autoincrement())
  role_name String   @unique @db.VarChar(50)
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String
  is_active  Boolean   @default(true)
  last_login DateTime?
  roles      Role[]

  profile             Profile?
  teacher_extension   TeacherExtension?
  student_extension   StudentExtension?
  guardian_extension  GuardianExtension?
  duties              DutySchedule[]
  homeroom_class      Classes?            @relation("HomeroomTeacher")
  teacher_assignments TeacherAssignment[]
  teaching_journals   TeachingJournal[]
  class_memberships   ClassMember[]

  // --- PERUBAHAN DI SINI ---
  // Relasi ke absensi harian (sebagai siswa)
  student_attendances      StudentAttendance[]
  // Relasi untuk guru/staf yang membuat QR harian
  generated_daily_sessions DailyAttendanceSession[] @relation("GeneratedBy")
  // --- AKHIR PERUBAHAN ---

  leave_permits_requested LeavePermit[]   @relation("Requester")
  leave_permits_approved  LeaveApproval[] @relation("Approver")
  leave_permits_printed   LeavePermit[]   @relation("PrintedBy")

  counseling_tickets_as_student   CounselingTicket[] @relation("StudentCounseling")
  counseling_tickets_as_counselor CounselingTicket[] @relation("CounselorTickets")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Profile {
  id              Int       @id @default(autoincrement())
  full_name       String
  identity_number String?   @unique
  gender          Gender
  address         String?   @db.Text
  phone_number    String?
  photo_url       String?
  birth_date      DateTime?

  user_id Int  @unique
  user    User @relation(fields: [user_id], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Gender {
  Laki_laki
  Perempuan
}

enum EmploymentStatus {
  PNS
  PPPK
  GTT
}

model TeacherExtension {
  id      Int               @id @default(autoincrement())
  user_id Int               @unique
  user    User              @relation(fields: [user_id], references: [id])
  nip     String?           @unique
  status  EmploymentStatus?
}

model StudentExtension {
  id          Int                @id @default(autoincrement())
  user_id     Int                @unique
  user        User               @relation(fields: [user_id], references: [id])
  nisn        String             @unique
  guardian_id Int?
  guardian    GuardianExtension? @relation(fields: [guardian_id], references: [id])
  slim_id     String?            @unique
}

model GuardianExtension {
  id         Int                @id @default(autoincrement())
  user_id    Int                @unique
  user       User               @relation(fields: [user_id], references: [id])
  occupation String?
  students   StudentExtension[]
}

// ============== MODUL 2: STRUKTUR AKADEMIK & JADWAL ==============

model AcademicYear {
  id                   Int                  @id @default(autoincrement())
  year                 String               @unique
  start_date           DateTime
  end_date             DateTime
  is_active            Boolean              @default(false)
  class_memberships    ClassMember[]
  teacher_assignments  TeacherAssignment[]
  schedules            Schedule[]
  academic_weeks       AcademicWeek[]
  special_events       SpecialEvent[]
  active_schedule_week ActiveScheduleWeek[]

  // Relasi baru ke absensi harian
  daily_attendance_sessions DailyAttendanceSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Major {
  id         Int       @id @default(autoincrement())
  major_name String    @unique
  major_code String    @unique
  classes    Classes[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Classes {
  id                        Int                      @id @default(autoincrement())
  class_name                String                   @unique
  grade_level               Int
  major_id                  Int
  major                     Major                    @relation(fields: [major_id], references: [id])
  homeroom_teacher_id       Int?                     @unique
  homeroom_teacher          User?                    @relation("HomeroomTeacher", fields: [homeroom_teacher_id], references: [id])
  class_members             ClassMember[]
  teacher_assignments       TeacherAssignment[]
  daily_attendance_sessions DailyAttendanceSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subject {
  id                  Int                 @id @default(autoincrement())
  subject_name        String
  subject_code        String              @unique
  teacher_assignments TeacherAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AcademicWeek {
  id               Int          @id @default(autoincrement())
  start_date       DateTime     @db.Date
  end_date         DateTime     @db.Date
  week_type        WeekType
  notes            String?
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
}

enum WeekType {
  A
  B
  Libur
  Ujian
  Acara
}

model Schedule {
  id               Int               @id @default(autoincrement())
  day_of_week      DayOfWeek
  start_time       DateTime          @db.Time
  end_time         DateTime          @db.Time
  schedule_type    ScheduleType      @default(Umum)
  assignment_id    Int
  assignment       TeacherAssignment @relation(fields: [assignment_id], references: [id])
  academic_year_id Int
  academic_year    AcademicYear      @relation(fields: [academic_year_id], references: [id])
  journals         TeachingJournal[]
  leave_permits    LeavePermit[]
  room_id          Int?
  room             Room?             @relation(fields: [room_id], references: [id])

  // --- PERUBAHAN DI SINI ---
  // qr_sessions         AttendanceQRSession[] // <-- DIHAPUS
  // --- AKHIR PERUBAHAN ---
}

enum DayOfWeek {
  Senin
  Selasa
  Rabu
  Kamis
  Jumat
}

enum ScheduleType {
  A
  B
  Umum
}

model SpecialEvent {
  id               Int          @id @default(autoincrement())
  event_name       String
  description      String?
  start_date       DateTime     @db.Date
  end_date         DateTime     @db.Date
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
}

model ActiveScheduleWeek {
  id               Int          @id @default(autoincrement())
  grade_level      Int // 10, 11, 12 (untuk X, XI, XII)
  active_week_type ScheduleType @default(Umum) // A, B, atau Umum
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
  updated_at       DateTime     @updatedAt

  @@unique([grade_level, academic_year_id])
}

model DutySchedule {
  id        Int      @id @default(autoincrement())
  user_id   Int
  user      User     @relation(fields: [user_id], references: [id])
  duty_date DateTime @db.Date
  duty_type String
  notes     String?

  @@unique([user_id, duty_date, duty_type])
}

model ClassMember {
  id               Int          @id @default(autoincrement())
  student_user_id  Int
  student          User         @relation(fields: [student_user_id], references: [id])
  class_id         Int
  class            Classes      @relation(fields: [class_id], references: [id])
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])

  @@unique([student_user_id, academic_year_id])
}

model TeacherAssignment {
  id               Int          @id @default(autoincrement())
  teacher_user_id  Int
  teacher          User         @relation(fields: [teacher_user_id], references: [id])
  subject_id       Int
  subject          Subject      @relation(fields: [subject_id], references: [id])
  class_id         Int
  class            Classes      @relation(fields: [class_id], references: [id])
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])
  schedules        Schedule[]
}

// ============== MODUL 3: ABSENSI HARIAN (BARU) ==============

// Model ini menggantikan AttendanceQRSession
// Ini adalah sesi harian yang unik per KELAS per hari
model DailyAttendanceSession {
  id           String   @id @default(uuid())
  session_date DateTime @db.Date
  qr_code      String   @unique

  // QR code dibuat per KELAS
  class_id Int
  class    Classes @relation(fields: [class_id], references: [id])

  // Waktu kedaluwarsa QR
  expires_at DateTime

  // ID Guru Piket/Admin/Guru yang generate QR
  created_by_id Int
  creator       User @relation("GeneratedBy", fields: [created_by_id], references: [id])

  // Terikat ke tahun ajaran aktif
  academic_year_id Int
  academic_year    AcademicYear @relation(fields: [academic_year_id], references: [id])

  // Semua absensi siswa untuk hari ini (di kelas ini) akan merujuk ke sini
  student_attendances StudentAttendance[]

  // Relasi ke jurnal KBM yang merujuk ke sesi harian ini
  teaching_journals TeachingJournal[]

  createdAt DateTime @default(now())

  // Kunci unik: 1 sesi per kelas per hari
  @@unique([session_date, class_id])
  @@index([created_by_id])
  @@index([academic_year_id])
  @@index([class_id])
}

// Model ini dimodifikasi untuk absensi harian
model StudentAttendance {
  id Int @id @default(autoincrement())

  // Link ke Sesi Harian (menggantikan qr_session_id)
  daily_session_id String
  daily_session    DailyAttendanceSession @relation(fields: [daily_session_id], references: [id], onDelete: Cascade)

  student_user_id Int
  student         User @relation(fields: [student_user_id], references: [id])

  status      AttendanceStatus @default(Hadir)
  scan_method String // "QR" atau "Manual" (sesuai permintaan Anda)

  // Waktu kapan siswa scan atau guru input manual
  marked_at DateTime @default(now())

  // Untuk fitur 'validasi guru lain' (WaliKelas/BK)
  is_verified    Boolean @default(false)
  verified_by_id Int? // ID guru yang memvalidasi

  notes String?

  // Kunci unik baru: Siswa hanya bisa absen 1x per sesi harian
  @@unique([daily_session_id, student_user_id])
  @@index([student_user_id])
}

// Model `AttendanceQRSession` (lama) telah dihapus

// ============== MODUL 4: JURNAL MENGAJAR ==============

model TeachingJournal {
  id              Int      @id @default(autoincrement())
  journal_date    DateTime @db.Date
  schedule_id     Int
  schedule        Schedule @relation(fields: [schedule_id], references: [id])
  teacher_user_id Int
  teacher         User     @relation(fields: [teacher_user_id], references: [id])

  // Status Guru
  teacher_status       String  @default("Hadir") // Hadir, Sakit, Izin, Alpa
  teacher_status_notes String? @db.Text // Alasan jika tidak hadir

  // Konten Jurnal (Jika Hadir)
  material_topic       String? // Topik materi pembelajaran
  material_description String? @db.Text // Deskripsi detail materi
  learning_method      String? // Ceramah, Diskusi, Praktik, dll
  learning_media       String? // Slides, Video, Modul, dll
  learning_achievement String? @db.Text // Capaian pembelajaran siswa
  teacher_notes        String? @db.Text // Catatan tambahan guru

  // Link ke Daily Attendance Session (read-only dari sistem absensi harian yang sudah ada)
  // Jurnal akan fetch data absensi dari DailyAttendanceSession berdasarkan kelas & tanggal
  daily_session_id String? // Optional: Link ke sesi absensi harian
  daily_session    DailyAttendanceSession? @relation(fields: [daily_session_id], references: [id])

  // Relations
  photos JournalPhoto[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schedule_id, journal_date])
  @@index([teacher_user_id])
  @@index([schedule_id])
  @@index([journal_date])
  @@index([daily_session_id])
}

model JournalPhoto {
  id         Int             @id @default(autoincrement())
  journal_id Int
  journal    TeachingJournal @relation(fields: [journal_id], references: [id], onDelete: Cascade)

  photo_url String // URL foto
  filename  String // Nama asli file
  file_size Int? // Ukuran file dalam bytes

  createdAt DateTime @default(now())

  @@index([journal_id])
}

// JournalStudentAttendance DIHAPUS - Jurnal hanya READ data dari DailyAttendanceSession
// Tidak ada duplikasi data absensi

// Enum ini dipakai oleh StudentAttendance dan Attendance (legacy)
enum AttendanceStatus {
  Hadir
  Izin
  Sakit
  Alfa
}

// Model legacy (dibiarkan sesuai permintaan)
model Attendance {
  id         Int              @id @default(autoincrement())
  status     AttendanceStatus @default(Hadir)
  notes      String?
  journal_id Int
  // Note: This uses journal_id but TeachingJournal now uses StudentAttendance instead
  // Kept for backward compatibility
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model Room {
  id        Int        @id @default(autoincrement())
  room_name String
  room_code String     @unique
  schedules Schedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============== MODUL 5: IZIN KELUAR SEKOLAH ==============
// (Tidak ada perubahan di modul ini)

enum RequesterType {
  Student
  Teacher
}

enum LeavePermitType {
  Individual
  Group
}

enum LeavePermitStatus {
  WaitingForPiket
  WaitingForApproval
  Approved
  Rejected
  Completed
}

enum ApprovalStatus {
  Pending
  Approved
  Rejected
}

model LeavePermit {
  id                  Int               @id @default(autoincrement())
  requester_user_id   Int
  requester           User              @relation("Requester", fields: [requester_user_id], references: [id])
  requester_type      RequesterType     @default(Student)
  leave_type          LeavePermitType
  reason              String            @db.Text
  start_time          DateTime          @db.Timestamp()
  estimated_return    DateTime?         @db.Timestamp()
  status              LeavePermitStatus @default(WaitingForPiket)
  approvals           LeaveApproval[]
  related_schedule_id Int?
  related_schedule    Schedule?         @relation(fields: [related_schedule_id], references: [id])
  group_members       Json?
  printed_by_id       Int?
  printed_by          User?             @relation("PrintedBy", fields: [printed_by_id], references: [id])
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([requester_user_id])
  @@index([printed_by_id])
  @@index([requester_type])
}

model LeaveApproval {
  id               Int            @id @default(autoincrement())
  leave_permit_id  Int
  leave_permit     LeavePermit    @relation(fields: [leave_permit_id], references: [id])
  approver_user_id Int
  approver         User           @relation("Approver", fields: [approver_user_id], references: [id])
  approver_role    String
  status           ApprovalStatus @default(Pending)
  notes            String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([leave_permit_id, approver_user_id])
  @@index([approver_user_id])
}

// ============== MODUL 6: E-COUNSELING ==============
// (Tidak ada perubahan di modul ini)

enum CounselingTicketStatus {
  OPEN
  PROSES
  DITOLAK
  CLOSE
}

model CounselingTicket {
  id                  Int                    @id @default(autoincrement())
  ticket_number       String                 @unique // Format: EC-2025-0001
  student_user_id     Int
  student             User                   @relation("StudentCounseling", fields: [student_user_id], references: [id])
  counselor_user_id   Int
  counselor           User                   @relation("CounselorTickets", fields: [counselor_user_id], references: [id])
  preferred_date      DateTime               @db.Date
  preferred_time      DateTime               @db.Time
  problem_description String                 @db.Text
  status              CounselingTicketStatus @default(OPEN)
  confirmed_schedule  DateTime?              @db.Timestamp()
  rejection_reason    String?                @db.Text
  counseling_notes    String?                @db.Text
  completion_notes    String?                @db.Text
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  @@index([student_user_id])
  @@index([counselor_user_id])
  @@index([status])
}
